<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pado.propagator &#8212; pado 0.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=12dfc556" />
    <script src="../../_static/documentation_options.js?v=d45e8c67"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for pado.propagator</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.fourier</span><span class="w"> </span><span class="kn">import</span> <span class="n">fft</span><span class="p">,</span> <span class="n">ifft</span><span class="p">,</span> <span class="n">fftshift</span><span class="p">,</span> <span class="n">ifftshift</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.complex</span><span class="w"> </span><span class="kn">import</span> <span class="n">Complex</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.conv</span><span class="w"> </span><span class="kn">import</span> <span class="n">conv_fft</span>


<div class="viewcode-block" id="compute_pad_width">
<a class="viewcode-back" href="../../api/propagator.html#pado.propagator.compute_pad_width">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_pad_width</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">linear</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the pad width of an array for FFT-based convolution</span>
<span class="sd">    Args:</span>
<span class="sd">        field: (B,Ch,R,C) complex tensor</span>
<span class="sd">        linear: True or False, flag for linear convolution (zero padding) or circular convolution (no padding)</span>
<span class="sd">    Returns:</span>
<span class="sd">        pad_width: pad-width tensor</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">linear</span><span class="p">:</span>
        <span class="n">R</span><span class="p">,</span><span class="n">C</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">shape</span><span class="p">()[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
        <span class="n">pad_width</span> <span class="o">=</span> <span class="p">(</span><span class="n">C</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">C</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">R</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">R</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pad_width</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pad_width</span> </div>


<div class="viewcode-block" id="unpad">
<a class="viewcode-back" href="../../api/propagator.html#pado.propagator.unpad">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">unpad</span><span class="p">(</span><span class="n">field_padded</span><span class="p">,</span> <span class="n">pad_width</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Unpad the already-padded complex tensor </span>
<span class="sd">    Args:</span>
<span class="sd">        field_padded: (B,Ch,R,C) padded complex tensor </span>
<span class="sd">        pad_width: pad-width tensor</span>
<span class="sd">    Returns:</span>
<span class="sd">        field: unpadded complex tensor</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">field</span> <span class="o">=</span> <span class="n">field_padded</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">pad_width</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="o">-</span><span class="n">pad_width</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">pad_width</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="o">-</span><span class="n">pad_width</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">field</span></div>


<div class="viewcode-block" id="fresnel_number">
<a class="viewcode-back" href="../../api/propagator.html#pado.propagator.fresnel_number">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">fresnel_number</span><span class="p">(</span><span class="n">wid</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">wvl</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate Fresnel Number to determine propagation method</span>
<span class="sd">    Args:</span>
<span class="sd">        wid: physical width of the light</span>
<span class="sd">        z: propagation distance</span>
<span class="sd">        wvl: wavelength of the light</span>
<span class="sd">    Return:</span>
<span class="sd">         Fresnel Number</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">wid</span> <span class="o">*</span> <span class="n">wid</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">z</span> <span class="o">*</span> <span class="n">wvl</span><span class="p">)</span></div>


<div class="viewcode-block" id="critical_sampling">
<a class="viewcode-back" href="../../api/propagator.html#pado.propagator.critical_sampling">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">critical_sampling</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">wvl</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate critical sampling to determine</span>
<span class="sd">    Impulse Response or Transfer Function for Fresnel</span>
<span class="sd">    Args:</span>
<span class="sd">        z: propagation distance</span>
<span class="sd">        wvl: wavelength of the light</span>
<span class="sd">        length: array length of the light</span>
<span class="sd">    Return:</span>
<span class="sd">         Critical Sampling</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">wvl</span> <span class="o">*</span> <span class="n">z</span> <span class="o">/</span> <span class="n">length</span></div>


<div class="viewcode-block" id="Propagator">
<a class="viewcode-back" href="../../api/propagator.html#pado.propagator.Propagator">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Propagator</span><span class="p">:</span>
<div class="viewcode-block" id="Propagator.__init__">
<a class="viewcode-back" href="../../api/propagator.html#pado.propagator.Propagator.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Free-space propagator of light waves</span>
<span class="sd">        One can simulate the propagation of light waves on free space (no medium change at all).</span>
<span class="sd">        Args:</span>
<span class="sd">            mode: type of propagator. currently, we support &quot;Fraunhofer&quot; propagation or &quot;Fresnel&quot; propagation. Use Fraunhofer for far-field propagation and Fresnel for near-field propagation. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span></div>


<div class="viewcode-block" id="Propagator.forward">
<a class="viewcode-back" href="../../api/propagator.html#pado.propagator.Propagator.forward">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">light</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">linear</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Forward the incident light with the propagator. </span>
<span class="sd">        Args:</span>
<span class="sd">            light: incident light </span>
<span class="sd">            z: propagation distance in meter</span>
<span class="sd">            linear: True or False, flag for linear convolution (zero padding) or circular convolution (no padding)</span>
<span class="sd">        Returns:</span>
<span class="sd">            light: light after propagation</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
            <span class="n">f_num</span> <span class="o">=</span> <span class="n">fresnel_number</span><span class="p">(</span><span class="n">light</span><span class="o">.</span><span class="n">R</span><span class="o">*</span><span class="n">light</span><span class="o">.</span><span class="n">pitch</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">light</span><span class="o">.</span><span class="n">wvl</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">f_num</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward_asm</span><span class="p">(</span><span class="n">light</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">linear</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">f_num</span> <span class="o">&lt;</span> <span class="mf">0.2</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward_Fraunhofer</span><span class="p">(</span><span class="n">light</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">linear</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward_Fresnel</span><span class="p">(</span><span class="n">light</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">linear</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;Fraunhofer&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward_Fraunhofer</span><span class="p">(</span><span class="n">light</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">linear</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;Fresnel&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward_Fresnel</span><span class="p">(</span><span class="n">light</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">linear</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;ASM&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward_asm</span><span class="p">(</span><span class="n">light</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">linear</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> propagator is not implemented&#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span></div>



<div class="viewcode-block" id="Propagator.forward_Fraunhofer">
<a class="viewcode-back" href="../../api/propagator.html#pado.propagator.Propagator.forward_Fraunhofer">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward_Fraunhofer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">light</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">linear</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Simulate Fraunhofer diffraction.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            light (Light): Input light wave</span>
<span class="sd">            z (float): Propagation distance in meters</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Light: Propagated light wave</span>
<span class="sd">        </span>
<span class="sd">        The Fraunhofer diffraction is calculated using the Fourier transform method.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">pad_width</span> <span class="o">=</span> <span class="n">compute_pad_width</span><span class="p">(</span><span class="n">light</span><span class="o">.</span><span class="n">field</span><span class="p">,</span> <span class="n">linear</span><span class="p">)</span>
        <span class="n">field_propagated</span> <span class="o">=</span> <span class="n">fft</span><span class="p">(</span><span class="n">light</span><span class="o">.</span><span class="n">field</span><span class="p">,</span> <span class="n">pad_width</span><span class="o">=</span><span class="n">pad_width</span><span class="p">)</span>
        <span class="n">field_propagated</span> <span class="o">=</span> <span class="n">unpad</span><span class="p">(</span><span class="n">field_propagated</span><span class="p">,</span> <span class="n">pad_width</span><span class="p">)</span>

        <span class="c1"># based on the Fraunhofer reparametrization (u=x/wvl*z) and the Fourier frequency sampling (1/bandwidth)</span>
        <span class="n">bw_r</span> <span class="o">=</span> <span class="n">light</span><span class="o">.</span><span class="n">get_bandwidth</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">bw_c</span> <span class="o">=</span> <span class="n">light</span><span class="o">.</span><span class="n">get_bandwidth</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">pitch_r_after_propagation</span> <span class="o">=</span> <span class="n">light</span><span class="o">.</span><span class="n">wvl</span><span class="o">*</span><span class="n">z</span><span class="o">/</span><span class="n">bw_r</span>
        <span class="n">pitch_c_after_propagation</span> <span class="o">=</span> <span class="n">light</span><span class="o">.</span><span class="n">wvl</span><span class="o">*</span><span class="n">z</span><span class="o">/</span><span class="n">bw_c</span>

        <span class="n">light_propagated</span> <span class="o">=</span> <span class="n">light</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>

        <span class="c1"># match the x-y pixel pitch using resampling</span>
        <span class="k">if</span> <span class="n">pitch_r_after_propagation</span> <span class="o">&gt;=</span> <span class="n">pitch_c_after_propagation</span><span class="p">:</span>
            <span class="n">scale_c</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">scale_r</span> <span class="o">=</span> <span class="n">pitch_r_after_propagation</span><span class="o">/</span><span class="n">pitch_c_after_propagation</span>
            <span class="n">pitch_after_propagation</span> <span class="o">=</span> <span class="n">pitch_c_after_propagation</span>
        <span class="k">elif</span> <span class="n">pitch_r_after_propagation</span> <span class="o">&lt;</span> <span class="n">pitch_c_after_propagation</span><span class="p">:</span>
            <span class="n">scale_r</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">scale_c</span> <span class="o">=</span> <span class="n">pitch_c_after_propagation</span><span class="o">/</span><span class="n">pitch_r_after_propagation</span>
            <span class="n">pitch_after_propagation</span> <span class="o">=</span> <span class="n">pitch_r_after_propagation</span>

        <span class="n">field_propagated</span><span class="o">.</span><span class="n">to_polar</span><span class="p">()</span>
        <span class="n">light_propagated</span><span class="o">.</span><span class="n">set_field</span><span class="p">(</span><span class="n">field_propagated</span><span class="p">)</span>
        <span class="n">light_propagated</span><span class="o">.</span><span class="n">magnify</span><span class="p">((</span><span class="n">scale_r</span><span class="p">,</span><span class="n">scale_c</span><span class="p">))</span>
        <span class="n">light_propagated</span><span class="o">.</span><span class="n">set_pitch</span><span class="p">(</span><span class="n">pitch_after_propagation</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">light_propagated</span></div>


<div class="viewcode-block" id="Propagator.forward_Fresnel">
<a class="viewcode-back" href="../../api/propagator.html#pado.propagator.Propagator.forward_Fresnel">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward_Fresnel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">light</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">linear</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Forward the incident light with the Fresnel propagator. </span>
<span class="sd">        Args:</span>
<span class="sd">            light: incident light </span>
<span class="sd">            z: propagation distance in meter. </span>
<span class="sd">            linear: True or False, flag for linear convolution (zero padding) or circular convolution (no padding)</span>
<span class="sd">        Returns:</span>
<span class="sd">            light: light after propagation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">field_input</span> <span class="o">=</span> <span class="n">light</span><span class="o">.</span><span class="n">field</span>

        <span class="c1"># compute the convolutional kernel</span>
        <span class="n">sx</span> <span class="o">=</span> <span class="n">light</span><span class="o">.</span><span class="n">C</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">sy</span> <span class="o">=</span> <span class="n">light</span><span class="o">.</span><span class="n">R</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">sx</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">sy</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">xx</span><span class="o">*</span><span class="n">light</span><span class="o">.</span><span class="n">pitch</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">light</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">yy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">yy</span><span class="o">*</span><span class="n">light</span><span class="o">.</span><span class="n">pitch</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">light</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">light</span><span class="o">.</span><span class="n">wvl</span>  <span class="c1"># wavenumber</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="p">(</span><span class="n">xx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">yy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">z</span><span class="p">))</span>
        <span class="n">amplitude</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span> <span class="o">/</span> <span class="n">z</span> <span class="o">/</span> <span class="n">light</span><span class="o">.</span><span class="n">wvl</span>
        <span class="n">conv_kernel</span> <span class="o">=</span> <span class="n">Complex</span><span class="p">(</span><span class="n">mag</span><span class="o">=</span><span class="n">amplitude</span><span class="p">,</span> <span class="n">ang</span><span class="o">=</span><span class="n">phase</span><span class="p">)</span> 
        
        <span class="c1"># Propagation with the convolution kernel</span>
        <span class="n">pad_width</span> <span class="o">=</span> <span class="n">compute_pad_width</span><span class="p">(</span><span class="n">field_input</span><span class="p">,</span> <span class="n">linear</span><span class="p">)</span>
        
        <span class="n">field_propagated</span> <span class="o">=</span> <span class="n">conv_fft</span><span class="p">(</span><span class="n">field_input</span><span class="p">,</span> <span class="n">conv_kernel</span><span class="p">,</span> <span class="n">pad_width</span><span class="p">)</span>

        <span class="c1"># return the propagated light</span>
        <span class="n">light_propagated</span> <span class="o">=</span> <span class="n">light</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">light_propagated</span><span class="o">.</span><span class="n">set_field</span><span class="p">(</span><span class="n">field_propagated</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">light_propagated</span></div>


<div class="viewcode-block" id="Propagator.forward_asm">
<a class="viewcode-back" href="../../api/propagator.html#pado.propagator.Propagator.forward_asm">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward_asm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">light</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">linear</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Forward the incident light with the ASM propagator.</span>
<span class="sd">        Args:</span>
<span class="sd">            light: incident light</span>
<span class="sd">            z: propagation distance in meter.</span>
<span class="sd">        Returns:</span>
<span class="sd">            light: light after propagation</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">field_input</span> <span class="o">=</span> <span class="n">light</span><span class="o">.</span><span class="n">field</span>
        
        <span class="n">fx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">light</span><span class="o">.</span><span class="n">C</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">light</span><span class="o">.</span><span class="n">C</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">light</span><span class="o">.</span><span class="n">pitch</span> <span class="o">*</span> <span class="n">light</span><span class="o">.</span><span class="n">C</span><span class="p">)</span>
        <span class="n">fy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">light</span><span class="o">.</span><span class="n">R</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">light</span><span class="o">.</span><span class="n">R</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">light</span><span class="o">.</span><span class="n">pitch</span> <span class="o">*</span> <span class="n">light</span><span class="o">.</span><span class="n">R</span><span class="p">)</span>
        <span class="n">fxx</span><span class="p">,</span> <span class="n">fyy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">fx</span><span class="p">,</span> <span class="n">fy</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;xy&#39;</span><span class="p">)</span>
        
        <span class="n">k</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">light</span><span class="o">.</span><span class="n">wvl</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="p">(</span><span class="n">light</span><span class="o">.</span><span class="n">wvl</span><span class="o">*</span><span class="n">fxx</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="n">light</span><span class="o">.</span><span class="n">wvl</span><span class="o">*</span><span class="n">fyy</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">k</span><span class="o">*</span><span class="n">z</span><span class="o">*</span><span class="n">gamma</span><span class="p">))))</span>
        <span class="n">conv_kernel</span> <span class="o">=</span> <span class="n">Complex</span><span class="p">(</span><span class="n">real</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">real</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">light</span><span class="o">.</span><span class="n">device</span><span class="p">),</span> 
                                  <span class="n">imag</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">imag</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">light</span><span class="o">.</span><span class="n">device</span><span class="p">))</span>
            
        <span class="n">pad_width</span> <span class="o">=</span> <span class="n">compute_pad_width</span><span class="p">(</span><span class="n">field_input</span><span class="p">)</span>
        <span class="n">field_propagated</span> <span class="o">=</span> <span class="n">conv_fft</span><span class="p">(</span><span class="n">field_input</span><span class="p">,</span> <span class="n">conv_kernel</span><span class="p">,</span> <span class="n">pad_width</span><span class="p">)</span>

        <span class="n">light_propagated</span> <span class="o">=</span> <span class="n">light</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">light_propagated</span><span class="o">.</span><span class="n">set_field</span><span class="p">(</span><span class="n">field_propagated</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">light_propagated</span></div>
</div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">pado</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/modules.html">pado</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, Seung-Hwan Baek, Yujin Jeon, Dong-ha Shin.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.4.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
    </div>

    

    
  </body>
</html>